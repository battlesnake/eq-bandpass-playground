"use strict";(self.webpackChunkjs=self.webpackChunkjs||[]).push([[179],{142:(t,e,s)=>{const o=[25,31.5,40,50,63,80,100,125,160,200,250,315,400,500,630,800,1e3,1250,1600,2e3,2500,3150,4e3,5e3,6300,8e3,1e4,12500,16e3,2e4];var n=function(t,e,s,o){return new(s||(s=Promise))((function(n,i){function r(t){try{a(o.next(t))}catch(t){i(t)}}function c(t){try{a(o.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,c)}a((o=o.apply(t,e||[])).next())}))};class i{constructor(t){this.strategy=t,this.q=1,this.eq=o.map(((t,e)=>({i:e,f:t,g:0,q:1}))),this.cursor={cursor_f:0,cursor_db:0,value_db:null},this.spectrum=new Float32Array(0),this.init=this.update_eq()}interpolate_db(t){const e=this.spectrum;for(let s=0;s<e.length-2;s+=2){const o=e[s],n=e[s+2];if(t>=o&&t<=n&&n>o){const i=(t-o)/(n-o),r=e[s+1];return r+i*(e[s+3]-r)}}return null}update_cursor(){this.cursor.value_db=this.interpolate_db(this.cursor.cursor_f)}update_eq(){return n(this,void 0,void 0,(function*(){this.spectrum=yield this.strategy.calculate(this.eq),this.update_cursor()}))}set_q(t){return n(this,void 0,void 0,(function*(){yield this.init,this.q=t;for(const e of this.eq)e.q=t;yield this.update_eq()}))}set_gain(t,e){return n(this,void 0,void 0,(function*(){yield this.init,this.eq[t].g=e,yield this.update_eq()}))}set_cursor(t,e){return n(this,void 0,void 0,(function*(){yield this.init,this.cursor={cursor_f:t,cursor_db:e,value_db:null},this.update_cursor()}))}}const r=s(59),c=s(803);function a(t){return r.debounce(t,60,{leading:!0,trailing:!0})}class h{constructor(t){this.model=t,this.debounced_set_q=a(this.set_q),this.debounced_set_gain=a(this.set_gain)}set_q(t,e){t.set_q(Math.pow(10,e/10))}set_gain(t,e,s){t.set_gain(e,s)}bind(t){const e=c.select("aside").selectAll("label.control.q").data([1]).enter().append("label").attr("class","control q");e.append("span").attr("class","control-name q").text("q"),e.append("input").attr("class","slider q").attr("type","range").attr("min","-10").attr("max","10").attr("value",0).on("input",(e=>this.debounced_set_q(t,e.currentTarget.value))),e.append("span").attr("class","control-value q").text("");const s=c.select("aside").selectAll("label.control.eq.g").data(o.map(((t,e)=>({x:t,i:e})))).enter().append("label").attr("class","control eq g");s.append("span").attr("class","control-name eq").text((({x:t})=>t<1e3?`${t}`:t/1e3+"k")),s.append("input").attr("class","slider eq").attr("type","range").attr("min","-32").attr("max","32").attr("value",0).on("input",((e,{i:s})=>this.debounced_set_gain(t,s,e.currentTarget.value))),s.append("span").attr("class","control-value eq").text("")}update(){const t=this.model,e=c.select("aside").selectAll("label.control.q").data([t.q]);e.select(".slider.q").attr("value",(e=>Math.round(10*Math.log10(t.q)))),e.select(".control-value.q").text((t=>t.toFixed(1)));const s=c.select("aside").selectAll("label.control.eq").data(t.eq);s.select(".slider.eq").attr("value",(t=>t.g)),s.select(".control-value.eq").text((t=>`${t.g}dB`))}}const l=.01,u=.98;class d{constructor(t,e=null,s=-60,o=60){var n,i;this.config=t,this.db_min=s,this.db_max=o,this.fmin=10,this.fmax=Math.min(2e4,t.rate/2),this.width=null!==(n=null==e?void 0:e.width)&&void 0!==n?n:0,this.height=null!==(i=null==e?void 0:e.height)&&void 0!==i?i:0}project(t,e){const{width:s,height:o}=this;return[(t*u+l)*s,(e*u+l)*o]}level_to_db(t){const{db_min:e,db_max:s}=this;return Math.min(s,Math.max(e,20*Math.log10(t)))}i_to_f(t){const{rate:e,size:s}=this.config;return t*e/s}f_to_i(t){const{size:e,rate:s}=this.config;return Math.min(e/2-1,Math.max(0,Math.round(t*e/s)))}project_x(t,e,s){const o=Math.log(t),n=Math.log(e);return(o-n)/(Math.log(s)-n)}project_f(t){return this.project_x(t,this.fmin,this.fmax)}project_db(t){const{db_min:e,db_max:s}=this;return(s-t)/(s-e)}unproject(t,e){const{width:s,height:o}=this;return[(t/s-l)/u,(e/o-l)/u]}unproject_f(t){const{fmin:e,fmax:s}=this,o=Math.log(e),n=Math.log(s);return Math.exp(t*(n-o)+o)}unproject_i(t){const{size:e,rate:s}=this.config,o=this.unproject_f(t);return this.f_to_i(Math.round(o*e/s))}unproject_db(t){const{db_min:e,db_max:s}=this;return s-t*(s-e)}}const p=s(59),f=s(803);class _{constructor(t,e){this.config=t,this.model=e;const s=f.select(".viewer");this.node=s.node(),this.context=this.node.getContext("2d")}onresize(){const t=this.node.clientWidth,e=this.node.clientHeight,s=window.devicePixelRatio;this.node.width=Math.round(t*s),this.node.height=Math.round(e*s),this.update()}onmovecursor(t,e,s){const o=f.select(".viewer").node(),{rate:n,size:i}=this.config,r=new d(this.config,o),[c,a]=r.unproject(e*devicePixelRatio,s*devicePixelRatio),h=r.unproject_f(c),l=r.unproject_db(a);t.set_cursor(h,l)}onmousemove(t,e){1&e.buttons&&this.onmovecursor(t,e.clientX,e.clientY)}ontouchmove(t,e){const s=e.touches.item(0);null!==s&&this.onmovecursor(t,s.clientX,s.clientY)}bind(t){new ResizeObserver(p.debounce((()=>this.onresize()),40,{leading:!0,trailing:!0})).observe(this.node),this.node.addEventListener("mousedown",(e=>this.onmousemove(t,e))),this.node.addEventListener("mousemove",(e=>this.onmousemove(t,e))),this.node.addEventListener("touchstart",(e=>this.ontouchmove(t,e))),this.node.addEventListener("touchmove",(e=>this.ontouchmove(t,e)))}update(){const t=this.config,e=this.model,s=this.node,o=this.context,n=s.width,i=s.height;o.clearRect(0,0,n,i);const r=new d(t,s),{db_min:c,db_max:a}=r;o.globalCompositeOperation="lighter";{o.lineWidth=2,o.strokeStyle="red",o.beginPath(),o.moveTo(...r.project(r.project_f(r.fmin),r.project_db(0)));const t=e.spectrum;for(let e=0;e<t.length;e+=2){const s=t[e],n=t[e+1];s>=r.fmin&&s<=r.fmax&&o.lineTo(...r.project(r.project_f(s),r.project_db(n)))}o.stroke()}o.strokeStyle="orange",o.lineWidth=4,o.beginPath(),o.moveTo(...r.project(r.project_f(r.fmin),r.project_db(0)));for(const{f:t,g:s}of e.eq)o.lineTo(...r.project(r.project_f(t),r.project_db(s)));o.lineTo(...r.project(r.project_f(r.fmax),r.project_db(0))),o.stroke(),o.lineWidth=6;for(const{f:t,g:s}of e.eq){const[e,c]=r.project(r.project_f(t),r.project_db(s));o.beginPath(),o.rect(e-1/n,c-1/i,2/n,2/i),o.stroke()}for(let t=r.fmin;t<r.fmax;t*=10)for(let e=1;e<10&&t*e<r.fmax;e++)o.lineWidth=1==e?4:2,o.strokeStyle=1==e?"blue":"green",o.beginPath(),o.moveTo(...r.project(r.project_f(t*e),0)),o.lineTo(...r.project(r.project_f(t*e),1)),o.stroke();for(let t=6*Math.ceil(c/6);t<=a;t+=6)o.lineWidth=0==t?4:2,o.strokeStyle=0==t?"blue":"green",o.beginPath(),o.moveTo(...r.project(0,r.project_db(t))),o.lineTo(...r.project(1,r.project_db(t))),o.stroke();o.lineWidth=4,o.strokeStyle="silver",o.beginPath(),o.moveTo(...r.project(0,0)),o.lineTo(...r.project(1,0)),o.lineTo(...r.project(1,1)),o.lineTo(...r.project(0,1)),o.lineTo(...r.project(0,0)),o.stroke();{const t=e.cursor;o.lineWidth=8,o.strokeStyle="cyan";const s=t.cursor_f,c=t.cursor_db,a=t.value_db,[h,l]=r.project(r.project_f(s),r.project_db(c));if(o.beginPath(),o.rect(h-1/n,l-1/i,2/n,2/i),o.stroke(),null!==a){o.setLineDash([4,4]);const[t,e]=r.project(r.project_f(s),r.project_db(a));o.beginPath(),o.rect(t-1/n,e-1/i,2/n,2/i),o.stroke(),o.lineWidth=2,o.beginPath(),o.moveTo(h,l),o.lineTo(t,e),o.stroke(),o.setLineDash([])}}}}const g=s(803);class v{constructor(t){this.model=t,this.node=g.select(".cursor")}bind(t){this.node.append("span").attr("class","cursor-x"),this.node.append("span").attr("class","cursor-y"),this.node.append("span").attr("class","cursor-v")}update(){var t;const{cursor_f:e,cursor_db:s,value_db:o}=this.model.cursor;this.node.select(".cursor-x").text(`x: ${e.toFixed(0)} Hz`),this.node.select(".cursor-y").text(`y: ${s.toFixed(2)} dB`),this.node.select(".cursor-v").text(`value: ${null!==(t=null==o?void 0:o.toFixed(2))&&void 0!==t?t:"-"} dB`)}}var b=function(t,e,s,o){return new(s||(s=Promise))((function(n,i){function r(t){try{a(o.next(t))}catch(t){i(t)}}function c(t){try{a(o.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,c)}a((o=o.apply(t,e||[])).next())}))};class m{constructor(t,e,s){this.config=t,this.model=e,this.views=s;for(const t of this.views)t.bind(this);this.update()}update(){for(const t of this.views)t.update()}set_q(t){return b(this,void 0,void 0,(function*(){yield this.model.set_q(t),this.update()}))}set_gain(t,e){return b(this,void 0,void 0,(function*(){yield this.model.set_gain(t,e),this.update()}))}set_cursor(t,e){return b(this,void 0,void 0,(function*(){yield this.model.set_cursor(t,e),this.update()}))}}class w{constructor(t){this.config=t}generate_all(){return{noise:this.generate_noise(),pure:this.generate_sine(this.config.rate/4)}}generate_noise(){const{size:t}=this.config,e=new Float32Array(t);for(let s=0;s<t;++s)e[s]+=(2*Math.random()-1)*Math.sqrt(t)*2;return e}generate_sine(t){const{size:e,rate:s}=this.config,o=new Float32Array(e);for(let n=0;n<e;++n)o[n]=Math.sin(2*Math.PI*t*n/s);return o}}class x{constructor(t=0,e=0,s=0,o=0,n=0){this.a1=t,this.a2=e,this.b0=s,this.b1=o,this.b2=n,this.xz1=0,this.xz2=0,this.yz1=0,this.yz2=0}static create_bandpass(t,e,s,o){const n=Math.pow(10,e/40),i=2*Math.PI*t/o,r=Math.sin(i),c=Math.cos(i),a=r/(2*s),h=1+a/n;return new x(-2*c/h,(1-a/n)/h,(1+a*n)/h,-2*c/h,(1-a*n)/h)}reset(){this.xz1=0,this.xz2=0,this.yz1=0,this.yz2=0}apply(t){const e=this.a1,s=this.a2,o=this.b0,n=this.b1,i=this.b2;let r=this.xz1,c=this.xz1,a=this.yz1,h=this.yz2;const l=t.length;new Float32Array(l);for(let u=0;u<l;++u){const l=t[u],d=l*o+r*n+c*i-a*e-h*s;t[u]=d,c=r,r=l,h=a,a=d}this.xz1=r,this.xz2=r,this.yz1=a,this.yz2=h}}class y{constructor(t,e){const{rate:s}=t;this.filters=e.map((({f:t,g:e,q:o})=>x.create_bandpass(t,e,o,s)))}apply(t){for(const e of this.filters)e.apply(t)}}var j=s(664),q=s.n(j);class M{constructor(t){this.config=t,this.fft=new(q())(t.size),this.signal=new w(t).generate_noise(),this.baseline=this.get_spectrum(this.signal)}get_spectrum(t){const e=new d(this.config),{size:s}=this.config,o=new Float32Array(2*s);this.fft.realTransform(o,[...t]);const n=new Float32Array(s);for(let i=0;i<s;i+=2){const s=Math.hypot(o[i],o[i+1])/Math.sqrt(t.length)/128;n[i]=e.i_to_f(i/2),n[i+1]=s}return n}calculate(t){return e=this,s=void 0,n=function*(){const e=new d(this.config),{size:s}=this.config,o=new Float32Array(this.signal);new y(this.config,t).apply(o);const n=this.get_spectrum(o);for(let t=1;t<n.length;t+=2)n[t]=e.level_to_db(n[t]/this.baseline[t]);return n},new((o=void 0)||(o=Promise))((function(t,i){function r(t){try{a(n.next(t))}catch(t){i(t)}}function c(t){try{a(n.throw(t))}catch(t){i(t)}}function a(e){var s;e.done?t(e.value):(s=e.value,s instanceof o?s:new o((function(t){t(s)}))).then(r,c)}a((n=n.apply(e,s||[])).next())}));var e,s,o,n}}class z{constructor(t){this.config=t,this.workers=[],this.job_serial=0,this.callbacks=new Map;const{rate:e}=this.config,o=new d(this.config),n=Math.log10(o.fmin),i=18*(Math.log10(o.fmax)-n);for(let e=0;e<=i;++e){const o=e/18+n,i=Math.pow(10,o),r=new Worker(new URL(s.p+s.u(145),s.b));r.onmessage=({data:t})=>{const e=t.id,s=this.callbacks.get(e);this.callbacks.delete(e),s(t)},r.postMessage({type:"init",config:t,freq:i}),this.workers.push(r)}}submit_job(t,e){const s=this.job_serial++;return new Promise(((o,n)=>{this.callbacks.set(s,o),t.postMessage({type:"job",id:s,bands:e})}))}calculate(t){return e=this,s=void 0,n=function*(){const e=yield Promise.all(this.workers.map((e=>this.submit_job(e,t)))),s=(new d(this.config),new Float32Array(2*e.length));let o=0;for(const{freq:t,db:n}of e)s[o++]=t,s[o++]=n;return s},new((o=void 0)||(o=Promise))((function(t,i){function r(t){try{a(n.next(t))}catch(t){i(t)}}function c(t){try{a(n.throw(t))}catch(t){i(t)}}function a(e){var s;e.done?t(e.value):(s=e.value,s instanceof o?s:new o((function(t){t(s)}))).then(r,c)}a((n=n.apply(e,s||[])).next())}));var e,s,o,n}}!function(){const t=window.location.hash.replace(/^#/,"")||"fourier",e={fourier:{rate:65536,size:32768},sines:{rate:6e4,size:2e4}}[t],s={fourier:()=>new M(e),sines:()=>new z(e)}[t](),o=new i(s),n=new h(o),r=new v(o),c=new _(e,o);new m(e,o,[n,r,c])}()}},t=>{t.O(0,[216],(()=>(142,t(t.s=142)))),t.O()}]);
//# sourceMappingURL=main.js.map