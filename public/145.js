(()=>{"use strict";const t=.01,e=.98;class s{constructor(t,e=null,s=-60,i=60){var n,r;this.config=t,this.db_min=s,this.db_max=i,this.fmin=10,this.fmax=Math.min(2e4,t.rate/2),this.width=null!==(n=null==e?void 0:e.width)&&void 0!==n?n:0,this.height=null!==(r=null==e?void 0:e.height)&&void 0!==r?r:0}project(s,i){const{width:n,height:r}=this;return[(s*e+t)*n,(i*e+t)*r]}level_to_db(t){const{db_min:e,db_max:s}=this;return Math.min(s,Math.max(e,20*Math.log10(t)))}i_to_f(t){const{rate:e,size:s}=this.config;return t*e/s}f_to_i(t){const{size:e,rate:s}=this.config;return Math.min(e/2-1,Math.max(0,Math.round(t*e/s)))}project_x(t,e,s){const i=Math.log(t),n=Math.log(e);return(i-n)/(Math.log(s)-n)}project_f(t){return this.project_x(t,this.fmin,this.fmax)}project_db(t){const{db_min:e,db_max:s}=this;return(s-t)/(s-e)}unproject(s,i){const{width:n,height:r}=this;return[(s/n-t)/e,(i/r-t)/e]}unproject_f(t){const{fmin:e,fmax:s}=this,i=Math.log(e),n=Math.log(s);return Math.exp(t*(n-i)+i)}unproject_i(t){const{size:e,rate:s}=this.config,i=this.unproject_f(t);return this.f_to_i(Math.round(i*e/s))}unproject_db(t){const{db_min:e,db_max:s}=this;return s-t*(s-e)}}class i{constructor(t=0,e=0,s=0,i=0,n=0){this.a1=t,this.a2=e,this.b0=s,this.b1=i,this.b2=n,this.xz1=0,this.xz2=0,this.yz1=0,this.yz2=0}static create_bandpass(t,e,s,n){const r=Math.pow(10,e/40),o=2*Math.PI*t/n,h=Math.sin(o),a=Math.cos(o),c=h/(2*s),l=1+c/r;return new i(-2*a/l,(1-c/r)/l,(1+c*r)/l,-2*a/l,(1-c*r)/l)}reset(){this.xz1=0,this.xz2=0,this.yz1=0,this.yz2=0}apply(t){const e=this.a1,s=this.a2,i=this.b0,n=this.b1,r=this.b2;let o=this.xz1,h=this.xz1,a=this.yz1,c=this.yz2;const l=t.length;new Float32Array(l);for(let u=0;u<l;++u){const l=t[u],_=l*i+o*n+h*r-a*e-c*s;t[u]=_,h=o,o=l,c=a,a=_}this.xz1=o,this.xz2=o,this.yz1=a,this.yz2=c}}class n{constructor(t,e){const{rate:s}=t;this.filters=e.map((({f:t,g:e,q:n})=>i.create_bandpass(t,e,n,s)))}apply(t){for(const e of this.filters)e.apply(t)}}class r{constructor(t){this.config=t}generate_all(){return{noise:this.generate_noise(),pure:this.generate_sine(this.config.rate/4)}}generate_noise(){const{size:t}=this.config,e=new Float32Array(t);for(let s=0;s<t;++s)e[s]+=(2*Math.random()-1)*Math.sqrt(t)*2;return e}generate_sinusoid(t,e=0){const{size:s,rate:i}=this.config,n=new Float32Array(s);for(let r=0;r<s;++r)n[r]=Math.sin(2*Math.PI*t*r/i+e);return n}generate_sine(t){return this.generate_sinusoid(t,0)}generate_cosine(t){return this.generate_sinusoid(t,Math.PI/2)}}class o{constructor(t,e){this.config=t,this.freq=e;const{rate:s}=t,i=s/e,n=6*i;this.sine=new r({size:n,rate:s}).generate_sine(e),this.cosine=new r({size:n,rate:s}).generate_cosine(e),this.period=i}normalised_inner_product(t,e){if(t.length<e.length)throw new Error("Domain error");let s=0;for(let i=0,n=e.length;i<n;++i)s+=t[i]*e[i];return 2*s/e.length}analyse_signal(t){const e=this.normalised_inner_product(this.sine,t),s=this.normalised_inner_product(this.cosine,t);return{magnitude:Math.hypot(s,e)}}calculate(t){const e=new s(this.config),i=new Float32Array(this.sine);new n(this.config,t).apply(i);const r=i.subarray(4*this.period),{magnitude:o}=this.analyse_signal(r);return{freq:this.freq,db:e.level_to_db(o)}}}let h;self.onmessage=function({data:t}){if("init"===t.type)return function(t){const{config:e,freq:s}=t;h=new o(e,s)}(t);var e;"job"===t.type&&(e=function(t){const{id:e,bands:s}=t,{freq:i,db:n}=h.calculate(s);return{type:"result",id:e,freq:i,db:n}}(t),self.postMessage(e))}})();
//# sourceMappingURL=145.js.map